// app/context/NotificationContext.tsx
"use client";

import React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';
import { useAuth } from './AuthContext';

// --- Types ---
export type NotificationType = 
  | 'cancel_class' 
  | 'school_holiday' 
  | 'attendance_reminder' 
  | 'entry_exit' 
  | 'absence_risk'
  | 'grade_alert'
  | 'payment'
  | 'meeting'
  | 'duty'
  | 'system';

export interface NotificationItem {
  id: number;
  type: NotificationType;
  title: string;
  message: string;
  fullDetail?: string;
  time: string;
  isRead: boolean;
}

// --- 1. Mock Data: à¸ªà¸³à¸«à¸£à¸±à¸šà¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™ ðŸ‘¨â€ðŸŽ“ ---
const studentNotifications: NotificationItem[] = [
  {
    id: 101,
    type: 'absence_risk',
    title: "à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™!",
    message: "à¸„à¸¸à¸“à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¸§à¸´à¸Šà¸² 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡' à¸ªà¸°à¸ªà¸¡à¸„à¸£à¸š 3 à¸„à¸£à¸±à¹‰à¸‡à¹à¸¥à¹‰à¸§",
    fullDetail: "à¹€à¸£à¸µà¸¢à¸™ à¸™à¸²à¸¢à¹€à¸­à¹‡à¸¡, à¸‚à¸“à¸°à¸™à¸µà¹‰à¸„à¸¸à¸“à¸¡à¸µà¸ªà¸–à¸´à¸•à¸´à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¸§à¸´à¸Šà¸² à¸„30201 à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸ªà¸°à¸ªà¸¡à¸„à¸£à¸š 3 à¸„à¸£à¸±à¹‰à¸‡ à¸‹à¸¶à¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¹€à¸à¸“à¸‘à¹Œà¹€à¸à¹‰à¸²à¸£à¸°à¸§à¸±à¸‡à¸£à¸°à¸”à¸±à¸š 1 (Warning) à¸«à¸²à¸à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¸­à¸µà¸ 1 à¸„à¸£à¸±à¹‰à¸‡ à¸ˆà¸°à¸«à¸¡à¸”à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ªà¸­à¸šà¸—à¸±à¸™à¸—à¸µ",
    time: "10 à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    isRead: false,
  },
  {
    id: 102,
    type: 'cancel_class',
    title: "à¹à¸ˆà¹‰à¸‡à¸‡à¸”à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™à¸à¸²à¸£à¸ªà¸­à¸™",
    message: "à¸§à¸´à¸Šà¸² à¸Ÿà¸´à¸ªà¸´à¸à¸ªà¹Œ (à¸„à¸²à¸š 5) à¸§à¸±à¸™à¸™à¸µà¹‰à¸‡à¸”à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™à¸à¸²à¸£à¸ªà¸­à¸™",
    fullDetail: "à¹à¸ˆà¹‰à¸‡à¸‡à¸”à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™à¸à¸²à¸£à¸ªà¸­à¸™ à¸§à¸´à¸Šà¸² à¸§30201 à¸Ÿà¸´à¸ªà¸´à¸à¸ªà¹Œ 1 à¸„à¸²à¸šà¸—à¸µà¹ˆ 5 à¸§à¸±à¸™à¸™à¸µà¹‰ à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¸„à¸£à¸¹à¸§à¸´à¸Šà¸±à¸¢à¸•à¸´à¸”à¸ à¸²à¸£à¸à¸´à¸ˆà¸£à¸²à¸Šà¸à¸²à¸£à¸”à¹ˆà¸§à¸™ à¹ƒà¸«à¹‰à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™à¸¨à¸¶à¸à¸©à¸²à¸„à¹‰à¸™à¸„à¸§à¹‰à¸²à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¸—à¸µà¹ˆà¸«à¹‰à¸­à¸‡à¸ªà¸¡à¸¸à¸”",
    time: "1 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    isRead: false,
  },
  {
    id: 103,
    type: 'entry_exit',
    title: "à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™à¹€à¸‚à¹‰à¸²à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
    message: "à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸§à¸¥à¸²à¹€à¸‚à¹‰à¸²à¹€à¸£à¸µà¸¢à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ (07:45 à¸™.)",
    time: "à¸§à¸±à¸™à¸™à¸µà¹‰ 07:45 à¸™.",
    isRead: true,
  },
];

// --- 2. Mock Data: à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸£à¸¹ ðŸ‘¨â€ðŸ« ---
const teacherNotifications: NotificationItem[] = [
  {
    id: 201,
    type: 'duty',
    title: "à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸§à¸£à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™",
    message: "à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸—à¹ˆà¸²à¸™à¸¡à¸µà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸§à¸£à¸£à¸±à¸šà¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™ à¸›à¸£à¸°à¸•à¸¹ 1 (07:00 - 08:00 à¸™.)",
    fullDetail: "à¹€à¸£à¸µà¸¢à¸™ à¸„à¸£à¸¹à¸ªà¸¡à¸¨à¸£à¸µ, à¸‚à¸­à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸ à¸²à¸£à¸à¸´à¸ˆà¹€à¸§à¸£à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰ à¸›à¸£à¸°à¸ˆà¸³à¸ˆà¸¸à¸”à¸›à¸£à¸°à¸•à¸¹ 1 à¸«à¸™à¹‰à¸²à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™ à¹€à¸§à¸¥à¸² 07:00 - 08:00 à¸™. à¸à¸£à¸¸à¸“à¸²à¸¡à¸²à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸à¹ˆà¸­à¸™à¹€à¸§à¸¥à¸² 10 à¸™à¸²à¸—à¸µ",
    time: "1 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    isRead: false,
  },
  {
    id: 202,
    type: 'absence_risk',
    title: "à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¸•à¸´à¸”à¸•à¹ˆà¸­à¸à¸±à¸™",
    message: "à¸™à¸²à¸¢à¸ªà¸¡à¸Šà¸²à¸¢ à¸¡à¸²à¸ªà¸²à¸¢ (à¸¡.5/1) à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¹€à¸à¸´à¸™ 3 à¸§à¸±à¸™à¹à¸¥à¹‰à¸§",
    fullDetail: "à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸žà¸šà¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡: à¸™à¸²à¸¢à¸ªà¸¡à¸Šà¸²à¸¢ à¸¡à¸²à¸ªà¸²à¸¢ à¹€à¸¥à¸‚à¸—à¸µà¹ˆ 3 à¸Šà¸±à¹‰à¸™ à¸¡.5/1 à¹„à¸”à¹‰à¸‚à¸²à¸”à¹€à¸£à¸µà¸¢à¸™à¸•à¸´à¸”à¸•à¹ˆà¸­à¸à¸±à¸™à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¸—à¸µà¹ˆ 3 à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸¥à¸²à¹ƒà¸™à¸£à¸°à¸šà¸š à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸­à¸šà¸–à¸²à¸¡à¸ªà¸²à¹€à¸«à¸•à¸¸",
    time: "à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™",
    isRead: false,
  },
  {
    id: 203,
    type: 'meeting',
    title: "à¸™à¸±à¸”à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸à¹ˆà¸²à¸¢à¸§à¸´à¸Šà¸²à¸à¸²à¸£",
    message: "à¸‚à¸­à¹€à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸”à¹ˆà¸§à¸™ à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸à¸²à¸£à¸ˆà¸±à¸”à¸ªà¸­à¸šà¸à¸¥à¸²à¸‡à¸ à¸²à¸„ à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œà¸™à¸µà¹‰",
    fullDetail: "à¹€à¸£à¸µà¸¢à¸™ à¸„à¸“à¸°à¸„à¸£à¸¹à¸à¹ˆà¸²à¸¢à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¸—à¸¸à¸à¸—à¹ˆà¸²à¸™, à¸‚à¸­à¹€à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸«à¸²à¸£à¸·à¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸à¸²à¸£à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸ªà¸­à¸šà¸à¸¥à¸²à¸‡à¸ à¸²à¸„à¹à¸¥à¸°à¸à¸²à¸£à¸­à¸­à¸à¸‚à¹‰à¸­à¸ªà¸­à¸š à¹ƒà¸™à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œà¸—à¸µà¹ˆ 16 à¸.à¸ž. à¹€à¸§à¸¥à¸² 15:30 à¸™. à¸“ à¸«à¹‰à¸­à¸‡à¸›à¸£à¸°à¸Šà¸¸à¸¡ 1",
    time: "2 à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    isRead: true,
  },
];

// --- 3. Mock Data: à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡ ðŸ‘ª ---
const parentNotifications: NotificationItem[] = [
  {
    id: 301,
    type: 'entry_exit',
    title: "à¸šà¸¸à¸•à¸£à¸«à¸¥à¸²à¸™à¸–à¸¶à¸‡à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¹‰à¸§",
    message: "à¸™à¹‰à¸­à¸‡à¹€à¸­à¹‡à¸¡ à¸ªà¹à¸à¸™à¹€à¸‚à¹‰à¸²à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¹€à¸§à¸¥à¸² 07:45 à¸™.",
    fullDetail: "à¸£à¸°à¸šà¸š EduTrack à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™: à¸™à¹‰à¸­à¸‡à¹€à¸­à¹‡à¸¡ à¹„à¸”à¹‰à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸¡à¸²à¸–à¸¶à¸‡à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¸°à¸ªà¹à¸à¸™à¸šà¸±à¸•à¸£à¹€à¸‚à¹‰à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸§à¸¥à¸² 07:45 à¸™. à¸ªà¸–à¸²à¸™à¸°: à¸›à¸à¸•à¸´",
    time: "à¸§à¸±à¸™à¸™à¸µà¹‰ 07:45 à¸™.",
    isRead: false,
  },
  {
    id: 302,
    type: 'payment',
    title: "à¹à¸ˆà¹‰à¸‡à¸Šà¸³à¸£à¸°à¸„à¹ˆà¸²à¸šà¸³à¸£à¸¸à¸‡à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²",
    message: "à¸šà¸´à¸¥à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡ 2/2566 à¸­à¸­à¸à¹à¸¥à¹‰à¸§ à¸à¸£à¸¸à¸“à¸²à¸Šà¸³à¸£à¸°à¸ à¸²à¸¢à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆ 28 à¸.à¸ž.",
    fullDetail: "à¹à¸ˆà¹‰à¸‡à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡, à¹ƒà¸šà¹à¸ˆà¹‰à¸‡à¸«à¸™à¸µà¹‰à¸„à¹ˆà¸²à¸šà¸³à¸£à¸¸à¸‡à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸² à¸ à¸²à¸„à¹€à¸£à¸µà¸¢à¸™à¸—à¸µà¹ˆ 2/2566 à¸‚à¸­à¸‡à¸™à¹‰à¸­à¸‡à¹€à¸­à¹‡à¸¡ à¹„à¸”à¹‰à¸­à¸­à¸à¹à¸¥à¹‰à¸§ à¸¢à¸­à¸”à¸£à¸§à¸¡ 12,500 à¸šà¸²à¸— à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹à¸à¸™ QR Code à¸Šà¸³à¸£à¸°à¸œà¹ˆà¸²à¸™à¹à¸­à¸›à¸˜à¸™à¸²à¸„à¸²à¸£à¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µ à¸«à¸£à¸·à¸­à¸Šà¸³à¸£à¸°à¸—à¸µà¹ˆà¸«à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸‡à¸´à¸™",
    time: "à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™",
    isRead: false,
  },
  {
    id: 303,
    type: 'meeting',
    title: "à¹€à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡",
    message: "à¸‚à¸­à¹€à¸£à¸µà¸¢à¸™à¹€à¸Šà¸´à¸à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡à¸Šà¸±à¹‰à¸™ à¸¡.5 à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œà¸—à¸µà¹ˆ 2 à¸¡à¸µ.à¸„.",
    fullDetail: "à¹€à¸£à¸µà¸¢à¸™ à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡, à¸—à¸²à¸‡à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¸‚à¸­à¹€à¸£à¸µà¸¢à¸™à¹€à¸Šà¸´à¸à¸—à¹ˆà¸²à¸™à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™à¸£à¸°à¸”à¸±à¸šà¸Šà¸±à¹‰à¸™à¸¡à¸±à¸˜à¸¢à¸¡à¸¨à¸¶à¸à¸©à¸²à¸›à¸µà¸—à¸µà¹ˆ 5 à¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸šà¸Ÿà¸±à¸‡à¸™à¹‚à¸¢à¸šà¸²à¸¢à¹à¸¥à¸°à¸œà¸¥à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™ à¹ƒà¸™à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œà¸—à¸µà¹ˆ 2 à¸¡à¸µà¸™à¸²à¸„à¸¡ à¹€à¸§à¸¥à¸² 09:00 - 12:00 à¸™. à¸“ à¸«à¸­à¸›à¸£à¸°à¸Šà¸¸à¸¡à¹ƒà¸«à¸à¹ˆ",
    time: "3 à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§",
    isRead: true,
  },
];


// --- Context Definition ---
interface NotificationContextType {
  notifications: NotificationItem[];
  unreadCount: number;
  markAsRead: (id: number) => void;
  markAllAsRead: () => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export function NotificationProvider({ children }: { children: ReactNode }) {
  const [notifications, setNotifications] = useState<NotificationItem[]>([]);
  const { user } = useAuth();

  useEffect(() => {
    // âœ… à¹ƒà¸Šà¹‰ setTimeout à¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² "setState synchronously"
    // à¹à¸¥à¸°à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸£à¸µà¸¢à¸ API à¸ˆà¸£à¸´à¸‡à¹†
    const timer = setTimeout(() => {
        if (!user) {
            setNotifications([]);
            return;
        }

        let newNotifications: NotificationItem[] = [];
        
        switch (user.role) {
            case 'student':
                newNotifications = studentNotifications;
                break;
            case 'teacher':
                newNotifications = teacherNotifications;
                break;
            case 'parent':
                newNotifications = parentNotifications;
                break;
            default:
                newNotifications = [];
        }

        setNotifications(newNotifications);
    }, 0); // à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸² 0ms à¸à¹‡à¹€à¸žà¸µà¸¢à¸‡à¸žà¸­à¹ƒà¸«à¹‰ JS à¸¢à¹‰à¸²à¸¢à¹„à¸›à¸—à¸³à¸‡à¸²à¸™à¹ƒà¸™ Next Tick

    return () => clearTimeout(timer); // Cleanup
  }, [user]);

  const markAsRead = (id: number) => {
    setNotifications(prev => prev.map(n => 
      n.id === id ? { ...n, isRead: true } : n
    ));
  };

  const markAllAsRead = () => {
    setNotifications(prev => prev.map(n => ({ ...n, isRead: true })));
  };

  const unreadCount = notifications.filter(n => !n.isRead).length;

  return (
    <NotificationContext.Provider value={{ notifications, unreadCount, markAsRead, markAllAsRead }}>
      {children}
    </NotificationContext.Provider>
  );
}

export function useNotification() {
  const context = useContext(NotificationContext);
  if (context === undefined) {
    throw new Error('useNotification must be used within a NotificationProvider');
  }
  return context;
}